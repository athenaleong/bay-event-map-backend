name: Daily Event Scraping

# Required GitHub Secrets:
# - BASE_URL: Your backend URL (e.g., https://your-backend.vercel.app)
# - CRON_SECRET: Secret for authenticating cron jobs
# - GCS_PROJECT_ID: Google Cloud project ID
# - GCS_BUCKET_NAME: Google Cloud Storage bucket name
# - GCS_CREDENTIALS: Service account JSON credentials
# - GCS_FILE_NAME: Optional, defaults to events/weekly-events.json

on:
  schedule:
    # Funcheap scraper - runs daily at 12:00 AM PST (8:00 AM UTC)
    - cron: '0 8 * * *'
    # Decentered Arts scraper - runs daily at 12:15 AM PST (8:15 AM UTC)  
    - cron: '15 8 * * *'
    # GCS export - runs daily at 12:30 AM PST (8:30 AM UTC)
    - cron: '30 8 * * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      scraper:
        description: 'Which scraper to run'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - both
        - funcheap
        - decentered
        - gcs-export

jobs:
  funcheap-scraper:
    if: github.event_name == 'schedule' || github.event.inputs.scraper == 'all' || github.event.inputs.scraper == 'both' || github.event.inputs.scraper == 'funcheap'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Run Funcheap Scraper
        run: |
          echo "üïõ Starting Funcheap scraper at $(date)"
          
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.BASE_URL }}/api/cron/daily-funcheap-scrap-one-week-ahead" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "üìä Response Status: $http_code"
          echo "üìã Response Body: $body"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 207 ]; then
            echo "‚úÖ Funcheap scraper completed successfully"
            echo "$body" | jq '.summary // {}'
          else
            echo "‚ùå Funcheap scraper failed with status $http_code"
            echo "$body"
            exit 1
          fi

  decentered-scraper:
    if: github.event_name == 'schedule' || github.event.inputs.scraper == 'all' || github.event.inputs.scraper == 'both' || github.event.inputs.scraper == 'decentered'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Run Decentered Arts Scraper
        run: |
          echo "üïõ Starting Decentered Arts scraper at $(date)"
          
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.BASE_URL }}/api/cron/daily-decentered-art-scrap-one-week-ahead" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "üìä Response Status: $http_code"
          echo "üìã Response Body: $body"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 207 ]; then
            echo "‚úÖ Decentered Arts scraper completed successfully"
            echo "$body" | jq '.summary // {}'
          else
            echo "‚ùå Decentered Arts scraper failed with status $http_code"
            echo "$body"
            exit 1
          fi

  gcs-export:
    if: github.event_name == 'schedule' || github.event.inputs.scraper == 'all' || github.event.inputs.scraper == 'gcs-export'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Export Events to Google Cloud Storage
        run: |
          echo "üïõ Starting GCS export at $(date)"
          
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.BASE_URL }}/api/cron/daily-gcs-export" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "üìä Response Status: $http_code"
          echo "üìã Response Body: $body"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 207 ]; then
            echo "‚úÖ GCS export completed successfully"
            echo "$body" | jq '.summary // {}'
          else
            echo "‚ùå GCS export failed with status $http_code"
            echo "$body"
            exit 1
          fi

  notify-completion:
    needs: [funcheap-scraper, decentered-scraper, gcs-export]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Notify Completion
        run: |
          echo "üìÖ Daily scraping workflow completed at $(date)"
          echo "üîç Check the individual job results above for details"
          echo ""
          echo "Job statuses:"
          echo "  - Funcheap scraper: ${{ needs.funcheap-scraper.result }}"
          echo "  - Decentered scraper: ${{ needs.decentered-scraper.result }}"
          echo "  - GCS export: ${{ needs.gcs-export.result }}"
