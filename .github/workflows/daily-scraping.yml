name: Daily Event Scraping

on:
  schedule:
    # Funcheap scraper - runs daily at 12:00 AM PST (8:00 AM UTC)
    - cron: '0 8 * * *'
    # Decentered Arts scraper - runs daily at 12:15 AM PST (8:15 AM UTC)  
    - cron: '15 8 * * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      scraper:
        description: 'Which scraper to run'
        required: true
        default: 'both'
        type: choice
        options:
        - both
        - funcheap
        - decentered

jobs:
  funcheap-scraper:
    if: github.event_name == 'schedule' || github.event.inputs.scraper == 'both' || github.event.inputs.scraper == 'funcheap'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Run Funcheap Scraper
        run: |
          echo "ğŸ•› Starting Funcheap scraper at $(date)"
          
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.BASE_URL }}/api/cron/daily-funcheap-scrap-one-week-ahead" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "ğŸ“Š Response Status: $http_code"
          echo "ğŸ“‹ Response Body: $body"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 207 ]; then
            echo "âœ… Funcheap scraper completed successfully"
            echo "$body" | jq '.summary // {}'
          else
            echo "âŒ Funcheap scraper failed with status $http_code"
            echo "$body"
            exit 1
          fi

  decentered-scraper:
    if: github.event_name == 'schedule' || github.event.inputs.scraper == 'both' || github.event.inputs.scraper == 'decentered'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Run Decentered Arts Scraper
        run: |
          echo "ğŸ•› Starting Decentered Arts scraper at $(date)"
          
          response=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.BASE_URL }}/api/cron/daily-decentered-art-scrap-one-week-ahead" \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            -H "Content-Type: application/json")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "ğŸ“Š Response Status: $http_code"
          echo "ğŸ“‹ Response Body: $body"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 207 ]; then
            echo "âœ… Decentered Arts scraper completed successfully"
            echo "$body" | jq '.summary // {}'
          else
            echo "âŒ Decentered Arts scraper failed with status $http_code"
            echo "$body"
            exit 1
          fi

  notify-completion:
    needs: [funcheap-scraper, decentered-scraper]
    if: always() && github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Completion
        run: |
          echo "ğŸ“… Daily scraping workflow completed at $(date)"
          echo "ğŸ” Check the individual job results above for details"
